let mapa;

window.addEventListener("load", function () {
    mapa = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM(),
            }),
        ],
        view: new ol.View({
            center: ol.proj.transform([-72.265911, 3.7644111], 'EPSG:4326', 'EPSG:3857'),
            zoom: 5,
        }),
    });

    mapa.on('click', function (evt) {
        let coordinates = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
        let latitud = coordinates[1].toFixed(6);
        let longitud = coordinates[0].toFixed(6);
        console.log("Latitud:", latitud);
        console.log("Longitud:", longitud);
        
        // Obtener datos de clima y ubicación
        obtenerDatosClima(latitud, longitud);
        obtenerDatosUbicacion(latitud, longitud);
    });
});

function obtenerDatosClima(lat, lon) {
    let url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.current_weather) {
                let temp = data.current_weather.temperature;
                let humedad = data.hourly?.relative_humidity_2m ? data.hourly.relative_humidity_2m[0] : 'N/A';
                actualizarUI(lat, lon, temp, humedad, null, null, null);
            } else {
                alert("No se pudo obtener el clima para esta ubicación.");
            }
        })
        .catch(error => console.error("Error obteniendo el clima:", error));
}

function obtenerDatosUbicacion(lat, lon) {
    let url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            let pais = data.address?.country || "Desconocido";
            let region = data.address?.state || "Desconocido";
            let ciudad = data.address?.city || data.address?.town || "Desconocido";
            actualizarUI(lat, lon, null, null, pais, region, ciudad);
        })
        .catch(error => console.error("Error obteniendo la ubicación:", error));
}

function actualizarUI(lat, lon, temp, humedad, pais, region, ciudad) {
    if (lat && lon) {
        document.getElementById("latitud_dato").textContent = lat;
        document.getElementById("longitud_dato").textContent = lon;
    }
    if (temp !== null) {
        document.getElementById("temperatura_dato").textContent = temp + " °C";
    }
    if (humedad !== null) {
        document.getElementById("humedad_dato").textContent = humedad + " %";
    }
    if (pais) {
        document.getElementById("pais_dato").textContent = pais;
    }
    if (region) {
        document.getElementById("region_dato").textContent = region;
    }
    if (ciudad) {
        document.getElementById("ciudad_dato").textContent = ciudad;
    }
    
    if (temp !== null && humedad !== null) {
        actualizarHistorial(lat, lon, temp, humedad);
    }
}

function actualizarHistorial(lat, lon, temp, humedad) {
    let tablaHistorial = document.querySelector("#tabla_historial");
    let fila = document.createElement("tr");
    fila.innerHTML = `<td>${lat}</td><td>${lon}</td><td>${temp} °C</td><td>${humedad} %</td>`;
    tablaHistorial.appendChild(fila);
}
